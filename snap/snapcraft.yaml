name: oval-core-tools
base: core22
version: '0.2'
summary: This snap provides basic tools for CVE Reporting on Ubuntu Core.
description: |
  This snap provides basic tools for OVAL-based CVE Reporting on Ubuntu Core.

grade: devel # must be 'stable' to release into candidate/stable channels
confinement: devmode # use 'strict' once you have the right plugs and slots

apps:
  cvereport:
    command: cvereport.sh
  scan:
    command: bin/snap_manifest.py
  generate-from-existing-manifests:
    command: bin/security_scan.py
    environment:
      PYTHONPATH: $SNAP/lib/python3.10/site-packages:$PYTHONPATH
    # PYTHONPATH: $SNAP/usr/lib/python3.8/dist-packages:$SNAP/lib/python3.8/site-packages:$SNAP/usr/lib/python3/dist-packages:$SNAP/lib/python3.8/dist-package/bs4:$SNAP/lib/python3.8/dist-package/bs4/builder:$PYTHONPATH

parts:
  snap-manifests:
    plugin: python
    source: ./snap-manifests
    #stage-packages: 
    #      - python3-wheel
    #    - python3-lxml
    #    - python3-bs4
    python-packages: [wheel, pyyaml, bs4, requests, html5lib, lxml]
  security-scan:
    plugin: dump
    source: ./security-scan
    organize:
      security_scan.py: bin/security_scan.py

  report:
    plugin: dump
    source: ./report
    stage-packages:
      - bzip2
      - curl
      - jq
      - libopenscap8
      - wget
      - xmlstarlet
    stage:
      - -usr/lib/*/libicuio.so.*
      - -usr/lib/*/libicutest.so.*
      - -usr/lib/*/libicutu.so*
      - -usr/lib/*/libicui18n.so*
      - -usr/lib/*/libopenscap_sce.so.*

layout:
  /usr/share/openscap/schemas:
    symlink: $SNAP/usr/share/openscap/schemas
  # required due to oval_probe_eval chdir() logic
  /usr/lib/$CRAFT_ARCH_TRIPLET/openscap:
    symlink: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/openscap
